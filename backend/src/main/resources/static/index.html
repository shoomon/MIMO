<!DOCTYPE html>
<html>
<head>
    <title>Team Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<div>
    <h2>Team Chat Room</h2>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type your message..." />
    <button onclick="sendMessage()">Send</button>
</div>

<script>
    let stompClient = null;
    let subscription = null;
    let AccessToken = "eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiIyIiwiaWF0IjoxNzM5NzQ5ODQwLCJleHAiOjE3Mzk3NTM0NDAsInR5cGUiOiJhY2Nlc3NUb2tlbiJ9.15BlKJpFVEag8wG3lpqoAfiC71d7zPvZnwHiKUNhLjAIJospnvWsE1CTct_NNBGw";

    // const teamId = sessionStorage.getItem("teamId"); // 클라이언트가 접속한 팀 ID
    const teamId = 1;
    console.log("teamId: " + teamId);

    function connect() {
        const socket = new SockJS('/ws?token='+AccessToken);
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // 팀별 채팅방 구독. 여기서 subscription으로 받은건 구독해제 시 사
            subscription = stompClient.subscribe('/sub/chat/' + teamId, function (message) {
                console.log(JSON.parse(message.body));
                showMessage(JSON.parse(message.body));
            });
        });
    }

    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = {
            message: messageInput.value
        };

        const header = {"Authorization":"eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiIxMSIsImlhdCI6MTczOTY5Nzc3MywiZXhwIjoxNzM5NzAxMzczLCJ0eXBlIjoiYWNjZXNzVG9rZW4ifQ.szW19Xt9mOCfsKJmLh_6cqnV8qzydgKSugzZcyfLitWIZB-VzCtYlF2wc7R_Zgqe"};
        stompClient.send(`/pub/chat-message/${teamId}`, header, JSON.stringify(message));
        messageInput.value = '';
    }

    function showMessage(message) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.textContent = `${message.chat}`;
        console.log(messageElement.textContent);
        console.log(messageElement);
        messagesDiv.appendChild(messageElement);
    }

    connect();
</script>
</body>
</html>
